<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>

	<!-- This bean substitutes variables from the env properties file -->
	<bean id="propertyConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
		<property name="location">
			<value>classpath:rsstotwitter.properties</value>
		</property>
	</bean>
		
	<bean id="tinyUrlService" class="nz.gen.wellington.tinyurl.TinyUrlService" />
	<bean id="twitterService" class="nz.gen.wellington.twitter.TwitterService">
		<property name="consumerKey" value="${consumer.key}" />
		<property name="consumerSecret" value="${consumer.secret}" />
	</bean>
	<bean id="feedDAO" class="nz.gen.wellington.rsstotwitter.feeds.FeedDAO" />
		
	<bean id="twitTextBuilderService" class="nz.gen.wellington.twitter.TwitTextBuilderService">
		<constructor-arg ref="tinyUrlService" />
	</bean>
			
	<bean id="hibernateTemplate" class="org.springframework.orm.hibernate3.HibernateTemplate">
		<constructor-arg ref="sessionFactory" />
	</bean>
		
	<bean id="twitterHistoryDAO" class="nz.gen.wellington.rsstotwitter.repositories.TwitterHistoryDAO">
		<constructor-arg ref="hibernateTemplate" />
	</bean>
	
	<bean id="feedToTwitterJobDAO" class="nz.gen.wellington.rsstotwitter.repositories.FeedToTwitterJobDAO">
		<constructor-arg ref="hibernateTemplate" />
	</bean>
	
	<bean id="tweetDAO" class="nz.gen.wellington.rsstotwitter.repositories.TweetDAO">
		<constructor-arg ref="hibernateTemplate" />
	</bean>

	<bean id="accountDAO" class="nz.gen.wellington.rsstotwitter.repositories.AccountDAO">
		<constructor-arg ref="hibernateTemplate" />
	</bean>
	
	<bean id="tweetFromFeedItemBuilder" class="nz.gen.wellington.rsstotwitter.twitter.TweetFromFeedItemBuilder">
		<constructor-arg ref="twitTextBuilderService" />
	</bean>
	
	<bean id="twitterUpdater" class="nz.gen.wellington.rsstotwitter.twitter.TwitterUpdater">
		<constructor-arg ref="twitterHistoryDAO" />
		<constructor-arg ref="twitterService" />
		<constructor-arg ref="tweetDAO" />
		<constructor-arg ref="tweetFromFeedItemBuilder" />	
	</bean>
			
	<bean id="updateService" class="nz.gen.wellington.rsstotwitter.timers.UpdateService">
		<constructor-arg ref="feedToTwitterJobDAO" />
		<constructor-arg ref="feedDAO" />
		<constructor-arg ref="twitterUpdater" />		
	</bean>
	
	<bean id="updateServiceRunner" class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">
  		<property name="targetObject" ref="updateService" />
  		<property name="targetMethod" value="run" />
  		<property name="concurrent" value="false" />
	</bean>
	
	<bean id="updateServiceTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
   		<property name="jobDetail" ref="updateServiceRunner" />
    	<property name="startDelay" value="60000" />
    	<property name="repeatInterval" value="600000" />
	</bean>
		
	<bean id="twitterArchiver" class="nz.gen.wellington.rsstotwitter.timers.TwitterArchiver">
		<constructor-arg ref="twitterService" />
		<constructor-arg ref="tweetDAO" />
		<constructor-arg ref="accountDAO" />
	</bean>
	
	<bean id="twitterArchiverRunner" class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">
  		<property name="targetObject" ref="twitterArchiver" />
  		<property name="targetMethod" value="run" />
  		<property name="concurrent" value="false" />
	</bean>
	
	<bean id="twitterArchiverTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
   		<property name="jobDetail" ref="twitterArchiverRunner" />
    	<property name="startDelay" value="60000" />
    	<property name="repeatInterval" value="86400000" />
	</bean>
	
	<bean id="autoFollower" class="nz.gen.wellington.rsstotwitter.timers.AutoFollower">
		<constructor-arg ref="twitterService" />
		<constructor-arg ref="accountDAO" />
	</bean>
	
	<bean id="autoFollowerRunner" class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">
  		<property name="targetObject" ref="autoFollower" />
  		<property name="targetMethod" value="run" />
  		<property name="concurrent" value="false" />
	</bean>
	
	<bean id="autoFollowerTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
   		<property name="jobDetail" ref="autoFollowerRunner" />
    	<property name="startDelay" value="60000" />
    	<property name="repeatInterval" value="600000" />
	</bean>
	
	<bean class="org.springframework.scheduling.quartz.SchedulerFactoryBean">
		<property name="triggers">
			<list>			
				<ref bean="autoFollowerTrigger"/>
				<ref bean="updateServiceTrigger" />
				<ref bean="twitterArchiverTrigger" />		
			</list>
		</property>
	</bean>
	
	<bean id="sessionFactory" class="org.springframework.orm.hibernate3.LocalSessionFactoryBean" lazy-init="false">
  		<property name="mappingResources">
    		<list>
	    		<value>Tweet.hbm.xml</value>
	    		<value>TwitterAccount.hbm.xml</value>	    		  
        		<value>TwitterEvent.hbm.xml</value>
       			<value>Feed.hbm.xml</value>
       			<value>FeedToTwitterJob.hbm.xml</value>       			
  	 		</list>
  		</property>
  		<property name="hibernateProperties">
    		<props>
    			<prop key="hibernate.transaction.auto_close_session">false</prop>
      			<prop key="hibernate.current_session_context_class">org.hibernate.context.ThreadLocalSessionContext</prop>
      			<prop key="hibernate.dialect">org.hibernate.dialect.MySQLDialect</prop>      	
      			<prop key="hibernate.cache.provider_class">org.hibernate.cache.EhCacheProvider</prop>
		      	<prop key="hibernate.cache.use_query_cache">false</prop>
      			<prop key="hibernate.cache.use_second_level_cache">false</prop>      	
		    </props>
		</property>
 		<property name="dataSource">
    		<ref bean="dataSource"/>
		</property>
	</bean>
		
	<bean id="dataSource" class="org.apache.commons.dbcp.BasicDataSource">
		<property name="driverClassName">
   			<value>com.mysql.jdbc.Driver</value>
 		</property>
 		<property name="url">
   			<value>jdbc:mysql://${database.host}/${database.name}?useUnicode=true&amp;characterEncoding=UTF-8</value>
 		</property>
 		
 		<property name="username">
   			<value>${database.username}</value>
 		</property>
 		<property name="password">
   			<value>${database.password}</value>
 		</property>
 		
 		<property name="maxActive">
   			<value>10</value>
 		</property>
 		
 		<property name="maxIdle">
   			<value>5</value>
 		</property> 		
	</bean>

	<bean id="homepageController" class="nz.gen.wellington.rsstotwitter.controllers.HomepageController">
		<property name="methodNameResolver">
			<bean
				class="org.springframework.web.servlet.mvc.multiaction.PropertiesMethodNameResolver">
				<property name="mappings">
					<props>
						<prop key="/">homepage</prop>
					</props>
				</property>
			</bean>
		</property>
	</bean>
	
	<bean id="loggedInUserFilter" class="nz.gen.wellington.rsstotwitter.controllers.LoggedInUserFilter" />
	
	<bean id="signinHandler" class="nz.gen.wellington.rsstotwitter.controllers.signin.TwitterLoginHandler">
		<constructor-arg ref="accountDAO" />
		<constructor-arg ref="twitterService" />
		<property name="consumerKey" value="${consumer.key}" />
		<property name="consumerSecret" value="${consumer.secret}" />
		<property name="callBackUrl" value="${callback.url}" />		
	</bean>
	
	<bean id="signinController" class="nz.gen.wellington.rsstotwitter.controllers.signin.SigninController">
		<constructor-arg ref="accountDAO" />
		<constructor-arg ref="signinHandler" />
		<constructor-arg ref="loggedInUserFilter" />	
		<property name="methodNameResolver">
			<bean
				class="org.springframework.web.servlet.mvc.multiaction.PropertiesMethodNameResolver">
				<property name="mappings">
					<props>
						<prop key="/oauth/login">login</prop>
						<prop key="/oauth/callback">callback</prop>						
					</props>
				</property>
			</bean>
		</property>
	</bean>
		
	<bean id="urlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
    	<property name="mappings">
            <props>
	           	<prop key="/">homepageController</prop>
	           	<prop key="/oauth/login">signinController</prop>
	           	<prop key="/oauth/callback">signinController</prop>	                    
            </props>
        </property>
    </bean>
    
	<bean id="velocityEngine" class="org.springframework.ui.velocity.VelocityEngineFactoryBean">
    	<property name="resourceLoaderPath" value="/WEB-INF/velocity"/>
	</bean>
	
	<bean id="velocityConfig" class="org.springframework.web.servlet.view.velocity.VelocityConfigurer">
	   <property name="velocityProperties">
	     	<props>
    	 		<prop key="output.encoding">UTF-8</prop>
         		<prop key="input.encoding">UTF-8</prop>
			</props>
		</property>
   		<property name="resourceLoaderPath" value="/WEB-INF/velocity"/>
	</bean>
	
	<bean id="viewResolver" class="org.springframework.web.servlet.view.velocity.VelocityViewResolver">
   		<property name="cache" value="true"/>
   		<property name="prefix" value=""/>
   		<property name="suffix" value=".vm"/>
   		<property name="contentType"><value>text/html;charset=UTF-8</value></property>
   		<property name="attributesMap">
		<map>
		</map>
		</property>
	</bean>
	    	        
</beans>